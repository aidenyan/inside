<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>添加商品</title>
    <link rel="stylesheet" href="../../common/css/amazeui.css?v=2.12">
    <link rel="stylesheet" href="../../layui/css/layui.css?v=2.12">
    <link rel="stylesheet" href="../../common/css/common.css?v=2.12">
    <link rel="stylesheet" href="../../common/css/font-style.css?v=2.12">
    <style>
        .content-wrpper {
            min-width: 1120px;
            padding: 20px;
            position: relative;
            height: 100%;
        }

        .layui-form-item .layui-input-inline {
            width: 338px;
        }

        .layui-input-block {
            margin-left: 165px;
            width: 864px;
        }

        .layui-form-label {
            width: 135px;
        }

        .layui-form-checkbox[lay-skin="primary"] span {
            padding-right: 6px;
        }

        span.explain {
            font-size: 12px;
            color: #999999;
        }

        .commodityAttributes .layui-input-inline {
            width: 800px;
        }

        .commodityAttributes .layui-input-inline .layui-form-checkbox[lay-skin="primary"] span {
            padding-right: 52px;
        }

        .layui-table td, .layui-table th {
            padding: 0;
            text-align: left;
            min-height: 20px;
            line-height: 30px;
        }

        .layui-table input {
            border: 0;
        }

        .btnBottom {
            width: 100%;
            text-align: center;
            position: absolute;
        }

        .sticky {
            position: fixed;
            top: 0;
        }
    </style>
</head>
<body style="">
<div class="mizone-add-com-fullPage">
    <form id="form_edit" class="layui-form">
        <div class="layui-tab layui-tab-brief">
            <ul class="layui-tab-title add-com-table-title">
                <li class="layui-this">基础信息</li>
                <li>商品介绍</li>
                <li class="sepc_select" style="display: none">商品规格</li>
                <li class="package_select" style="display: none">商品套装</li>
            </ul>
            <div class="layui-tab-content">
                <div class="layui-tab-item layui-show">
                    <div class="infor-show-dotted">
                        <i class="icon-gongsisvgtubiaozongji22"
                           style="color:#009cff;background-color: #009cff;font-size: 12px!important;"></i>
                        <span id="product_id_show">基础信息</span>
                    </div>
                    <div class="layui-form mizone-form" id="index_div_id">

                    </div>

                    <div class="infor-show-dotted">
                        <i class="icon-gongsisvgtubiaozongji22"
                           style="color:#009cff;background-color: #009cff;font-size: 12px!important;"></i>
                        <span>设置信息</span>
                    </div>
                    <div class="layui-form">
                        <div class="layui-form-item mizo-marginB-0">
                            <div class="layui-inline">
                                <label class="layui-form-label padd_top">标签</label>
                                <div class="layui-input-block" id="tag_info_list">

                                </div>
                            </div>
                        </div>
                        <div class="layui-form">
                            <div class="layui-form-item mizo-marginB-0">
                                <div class="layui-inline">
                                    <label class="layui-form-label padd_top">设置</label>
                                    <div class="layui-input-block">
                                        <input type="checkbox" id="product_isMarketable" name="productInfo.isMarketable"
                                               lay-filter="product_isMarketable" value="1" lay-skin="primary"
                                               title="上架">
                                        <input type="checkbox" id="product_isEnabled" name="productInfo.isEnabled"
                                               value="1" lay-filter="product_isEnabled" lay-skin="primary"
                                               title="启用">
                                        <input type="checkbox" id="product_isGift" name="productInfo.isGift" value="1"
                                               lay-skin="primary" title="赠品">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="layui-form">
                            <div class="layui-inline">
                                <label class="layui-form-label padd_top"></label>
                                <div class="layui-input-block product_type ">
                                    <input type="radio" lay-skin="primary" name="productInfo.productType"
                                           class="no_update" id="product_info_product_type_spec" value="1"
                                           lay-filter="spec_package_radio" title="多规格">
                                    <input type="radio" lay-skin="primary" name="productInfo.productType"
                                           class="no_update" value="2"
                                           lay-filter="spec_package_radio" title="套餐">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="infor-show-dotted" id="product_img_list">
                        <input type="hidden" name="productInfo.urlPath" id="product_img_url_path">
                        <i class="icon-gongsisvgtubiaozongji22"
                           style="color:#009cff;background-color: #009cff;font-size: 12px!important;"></i>
                        <span>商品图片</span> <span class="explain">*请至少上传一张商品图片(800*800像素),最多上传5张</span>
                    </div>
                    <div class="layui-form">
                        <div class="mizone-upload-case" id="upload_send_img">
                            <div class="mizone-upload" id="mizone-upload-case">
                                <div class="mizone-upload-drag">
                                    <i class="layui-icon">&#xe654;</i>
                                    <input type="file" id="update_img_data" lay-verify="productImg"
                                           lay-filter="mizone-upload-drag" name="file">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="layui-tab-item">
                    <textarea class="layui-textarea" id="com_uploade" style="display: none" lay-verify="img"
                    ></textarea>
                </div>
                <div class="layui-tab-item">
                    <div class="infor-show-dotted">
                        <i class="icon-gongsisvgtubiaozongji22"
                           style="color:#009cff;background-color: #009cff;font-size: 12px!important;"></i>
                        <span>商品规格</span>
                    </div>
                    <div class="layui-form">
                        <div class="layui-form-item">
                            <div class="layui-inline commodityAttributes">
                                <div class="layui-input-inline" id="spec_id">
                                </div>
                            </div>
                        </div>

                    </div>
                    <div class="infor-show-dotted">
                        <i class="icon-gongsisvgtubiaozongji22"
                           style="color:#009cff;background-color: #009cff;font-size: 12px!important;"></i>
                        <span>商品规格值设置</span> <span class="explain">*规格值请不要重复设置</span>
                    </div>
                    <div class="layui-form">
                        <table class="layui-table">
                            <thead>
                            <tr>
                                <th class="show_product_detail_id" style="display:none">广告ID</th>
                                <th class="">SKU随机码</th>
                                <th class="">商品条码</th>
                                <th class="" id="detail_sale_price">销售单价</th>
                                <th class="" style="display: none">采购单价</th>
                                <th class="input_small_point" style="display: none">小车经销商积分</th>
                                <th class="">说明</th>
                                <th class="">备注</th>
                                <th class="action-items">操作</th>
                            </tr>
                            </thead>
                            <tbody id="detail_tbody">

                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="layui-tab-item">
                    <div class="infor-show-dotted">
                        <i class="icon-gongsisvgtubiaozongji22"
                           style="color:#009cff;background-color: #009cff;font-size: 12px!important;"></i>
                        <span>商品套装</span>
                    </div>

                    <div class="">
                        <table class="layui-table">
                            <colgroup>
                                <col width="100">
                                <col width="300">
                                <col width="100">
                                <col width="100">
                                <col width="100">
                                <col width="168">
                                <col width="170">
                                <col width="120">
                            </colgroup>
                            <thead>
                            <tr>
                                <th class="">序号</th>
                                <th class="">SKU编码/商品名称</th>
                                <th class="">品牌</th>
                                <th class="">单位</th>
                                <th class="">商品分类</th>
                                <th class="">数量</th>
                                <th class="">操作</th>
                            </tr>
                            </thead>
                            <tbody id="package_tbody">
                            <tr class="package_add_clone_tr">
                                <input type="hidden" class="child_detail_package_Id"
                                       name="productPackageList[0].id"/>
                                <input type="hidden" class="child_detail_package_sku_code"
                                       name="productPackageList[0].skuCode"/>
                                <input type="hidden" class="child_detail_sku_Id"
                                       name="productPackageList[0].childDetailId"/>
                                <input type="hidden" class="child_detail_sku_name_hidden"
                                />
                                <td class="package_order">1</td>
                                <td class="sku_input_td">
                                    <div class="mizone-input-number">
                                        <div class="mizone-input-number-input">
                                            <input type="text" maxlength="23"
                                                   class="layui-input sku_input no_update" placeholder="请输入SKU编码">
                                        </div>
                                        <dl class="mizone-input-up" style="display: none">

                                        </dl>
                                    </div>
                                </td>
                                <td class="brand"></td>
                                <td class="unit"></td>
                                <td class="category"></td>
                                <td>
                                    <div class="mizone-input-number">
                                        <div class="mizone-input-number-handler-wrap">
                                            <i class="layui-icon up_num no_update"
                                               style="-moz-user-select:none;">&#xe619;</i>
                                            <i class="layui-icon down_num no_update"
                                               style="-moz-user-select:none;">&#xe61a;</i>
                                        </div>
                                        <div class="mizone-input-number-input">
                                            <input type="text" name="productPackageList[0].productNum" value="1"
                                                   placeholder="请输入商品数量" maxlength="9"
                                                   class="layui-input package_product_num no_update">
                                        </div>
                                    </div>
                                </td>
                                <td class="state_uhandle">
                                    <div class="">
                                        <a class=" update package_add_clone no_update">
                                            <i class="icon-plus2"></i>
                                        </a>
                                        <a class=" delete package_delete_clone no_update">
                                            <i class="icon-delete"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
            <div class="btnBottom ">
                <button class="layui-btn layui-btn-small form_submit next_close" lay-submit lay-filter="form_submit_close">
                    保存并关闭
                </button>
                <button class="layui-btn layui-btn-small form_submit next_update" lay-submit lay-filter="form_submit_update">
                    保存并新增
                </button>
                <button class="layui-btn layui-btn-small" id="cancel">取消</button>
            </div>
        </div>
        <div style="display: none">
            <input type="file" id="update_hiden_data" name="file"></div>

    </form>
</div>

<div class="mizone-upload-list" id="j-img-loading" style="display: none">
    <!--<img src="../common/image/wKgeS1ib-UOALKcqAAAJhQ-7X_E814_80x80.png" alt="">
    <div class="mizone-upload-list-cover">
        <i class="layui-icon">&#xe603;</i>
        <i class="layui-icon">&#xe602;</i>
        <i class="layui-icon">&#xe642;</i>
        <i class="layui-icon">&#xe640;</i>
    </div>-->
    <i class="icon-loading1 layui-anim-rotate"></i>
</div>
</body>
<script type="text/javascript" src="../admin.js"></script>
<script type="x-jsrender" id="j-index">
    <input type="hidden" id="product_id" name="productInfo.id" value="{{if productInfo && productInfo.id}}{{:productInfo.id}}{{/if}}"/>
    <div class="layui-form-item mizone-form-item">
        <div class="">
            <label class="layui-form-label padd_top"><span style="color:red">*</span>上架平台</label>
            <div class="layui-input-block" id="platform_id">

            </div>
        </div>
    </div>
    <div class="layui-form-item mizone-form-item">
        <div>
            <label class="layui-form-label padd_top"><span style="color:red">*</span>商品名称</label>
            <div class="layui-input-block">
                <input type="text" name="productInfo.name" lay-verify="required"
                       placeholder="商品名称"  maxlength="120" value="{{if productInfo && productInfo.name}}{{:productInfo.name}}{{/if}}" required-message="商品名称不能为空" class="layui-input">
            </div>
        </div>
    </div>
    <div class="layui-form-item mizone-form-item">
        <div class="">
            <label class="layui-form-label padd_top"><span style="color:red">*</span>SKU分类品台</label>
            <div class="layui-input-block" id="category_platform_id">
            <input type="radio" lay-skin="primary" name="productInfo.categoryFirstNum"  lay-verify="skuFirstCategory"
                       class="no_update" id="category_first_ckj" value="1" {{if productInfo && productInfo.categoryFirstNum==1}}checked="checked"{{/if}}
                       title="车空间(1)">
                <input type="radio" lay-skin="primary" id="category_first_oem" name="productInfo.categoryFirstNum"  lay-verify="skuFirstCategory"
                       class="no_update" value="2"  {{if productInfo && productInfo.categoryFirstNum==2}}checked="checked"{{/if}}
                       title="OEM(2)">
              <input type="radio" lay-skin="primary"  id="category_first_qdk" name="productInfo.categoryFirstNum"  lay-verify="skuFirstCategory"
                       class="no_update" value="3"  {{if productInfo && productInfo.categoryFirstNum==3}}checked="checked"{{/if}}
                       title="渠道科(3)">
            </div>
        </div>
    </div>
    <div class="layui-form-item mizone-form-item">
        <div>
            <label class="layui-form-label padd_top"><span style="color:red">*</span>商品简称</label>
            <div class="layui-input-block">
                 <input type="text" name="productInfo.shortName" lay-verify="required|length"
                       placeholder="商品简称"  maxlength="120" value="{{if productInfo && productInfo.shortName}}{{:productInfo.shortName}}{{/if}}" required-message="商品简称不能为空" class="layui-input">
            </div>
        </div>
    </div>
   <div class="layui-form-item mizone-form-item">
        <div class="layui-inline">
            <label class="layui-form-label padd_top"><span style="color:red">*</span>销售单价</label>
            <div class="layui-input-inline">
                <input type="tel" name="productInfo.price"  placeholder="请输入销售单价" lay-verify="required|price" value="{{if productInfo && productInfo.price}}{{:productInfo.price}}{{/if}}" required-message="基本信息的销售单价不能为空" autocomplete="off"
                 maxlength="8"    class="layui-input">
            </div>
        </div>
    </div>
    <div class="layui-form-item mizone-form-item">
        <div class="layui-inline">
            <label class="layui-form-label padd_top">SKU随机码</label>
            <div class="layui-input-inline">
                <input type="tel" name="productInfo.skuCodeRandom" value="{{if productInfo && productInfo.skuCodeRandom}}{{:productInfo.skuCodeRandom}}{{/if}}"  lay-verify="skuNo" autocomplete="off"
                     placeholder="请输入SKU随机码" maxlength="4"  class="layui-input  product_sku_code pre_sku_no_verify no_update" message="基本信息的">
            </div>
        </div>
        <div class="layui-inline">
            <label class="layui-form-label padd_top">商品条码</label>
            <div class="layui-input-inline">
                <input type="text" name="productInfo.sn" value="{{if productInfo && productInfo.sn}}{{:productInfo.sn}}{{/if}}"  lay-verify="sn" autocomplete="off" message="基本信息的"
                    placeholder="请输入商品条码"  maxlength="23"     class="layui-input no_update_no_blank">
            </div>
        </div>
    </div>

    <div class="layui-form-item mizone-form-item">
        <div class="layui-inline">
            <label class="layui-form-label padd_top"><span style="color:red">*</span>商品分类</label>
           <input type="hidden" name="productInfo.categoryId" id="category_id_value"value="{{if productInfo && productInfo.categoryId}}{{:productInfo.categoryId}}{{/if}}"/>
            <div class="layui-input-inline no_update">
                <!--<select name="productInfo.categoryId"class="no_update" value="{{if productInfo && productInfo.categoryId}}{{:productInfo.categoryId}}{{/if}}"  id="category_id" required-message="商品分类不能为空" lay-verify="required" lay-search>
                    <option value="">请选择分类</option>
                </select>-->
                <div class="am-selected am-dropdown  am-active" id="am-selected-category_id" style="width: 338px">
                <input type="text" class="am-selected-btn am-btn am-dropdown-toggle am-btn-default" lay-verify="selectCategoryId"
                        placeholder="请选择分类">
                <i class="edge"></i>
                <div class="am-selected-content am-dropdown-content"
                     style="min-width: 338px;display: none">
                    <div class="am-selected-search">
                        <input autocomplete="off" class="am-form-field am-input-sm">
                    </div>
                    <ul class="am-selected-list" style="max-height: 300px;overflow-y: auto" id="category_id">
                    </ul>
                    <div class="am-selected-hint"></div>
                </div>
                </div>
            </div>
        </div>
        <div class="layui-inline">
            <label class="layui-form-label padd_top"><span style="color:red">*</span>商品品牌</label>
            <input type="hidden" name="productInfo.brandId" id="brand_id_value"value="{{if productInfo && productInfo.brandId}}{{:productInfo.brandId}}{{/if}}"/>
            <div class="layui-input-inline">
                <!--<select name="productInfo.brandId" class="no_update" value="{{if productInfo && productInfo.brandId}}{{:productInfo.brandId}}{{/if}}"  lay-verify="required" required-message="商品品牌不能为空"  id="brand_id">-->
                    <!--<option value="">请选择品牌</option>-->
                <!--</select>-->
                <div class="am-selected am-dropdown  am-active" id="am-selected" style="width: 338px">
                <input type="text" class="am-selected-btn am-btn am-dropdown-toggle am-btn-default" lay-verify="selectBrandId"
                        placeholder="请选择品牌">
                <i class="edge"></i>
                <div class="am-selected-content am-dropdown-content"
                     style="min-width: 338px;display: none">
                    <div class="am-selected-search">
                        <input autocomplete="off" class="am-form-field am-input-sm">
                    </div>
                    <ul class="am-selected-list" style="max-height: 300px;overflow-y: auto" id="brand_id">
                    </ul>
                    <div class="am-selected-hint"></div>
                </div>
                </div>
            </div>
        </div>
    </div>

    <div class="layui-form-item mizone-form-item">
        <div class="layui-inline">
            <label class="layui-form-label padd_top"><span style="color:red">*</span>单位</label>
            <div class="layui-input-inline">
                <input type="tel" name="productInfo.unit"  value="{{if productInfo && productInfo.unit}}{{:productInfo.unit}}{{/if}}"  lay-verify="required"  required-message="单位不能为空" autocomplete="off"
                    placeholder="请输入商品单位"   maxlength="4"      class="layui-input">
            </div>
        </div>
        <div class="layui-inline">
            <label class="layui-form-label padd_top"><span style="color:red">*</span>重量/kg</label>
            <div class="layui-input-inline">
                <input type="text" name="productInfo.weight" value="{{if productInfo && productInfo.weight}}{{:productInfo.weight}}{{/if}}" lay-verify="decimal" message="重量" autocomplete="off"
                       placeholder="请输入商品重量"  maxlength="8"   lay-verify="required"  class="layui-input">
            </div>
        </div>
    </div>

    <div class="layui-form-item mizone-form-item">
        <div class="layui-inline">
            <label class="layui-form-label padd_top"><span style="color:red">*</span>包装规格</label>
            <div class="layui-input-inline">
                <input type="tel" name="productInfo.packageNum"class="layui-input    no_update"  value="{{if productInfo && productInfo.packageNum}}{{:productInfo.packageNum}}{{/if}}"  lay-verify="num|required" message="包装规格"
                       autocomplete="off"  maxlength="3"
                 placeholder="请输入商品包装规格" class="layui-input ">
            </div>
        </div>
        <div class="layui-inline">
            <label class="layui-form-label padd_top"><span style="color:red">*</span>包装单位</label>
            <div class="layui-input-inline">
                <input type="text"    placeholder="请输入商品包装单位" lay-verify="required"  class="layui-input    no_update"   name="productInfo.packageUnit" maxlength="5" value="{{if productInfo && productInfo.packageUnit}}{{:productInfo.packageUnit}}{{/if}}"  class="layui-input">
            </div>
        </div>
    </div>

    <div class="layui-form-item mizone-form-item">
    <div class="layui-inline">
        <label class="layui-form-label padd_top">起订数量</label>
            <div class="layui-input-inline">
                <input type="text" name="productInfo.sinceNumber"   placeholder="请输入起订数量"  value="{{if productInfo && productInfo.sinceNumber}}{{:productInfo.sinceNumber}}{{/if}}"  lay-verify="num" message="起订数量" autocomplete="off"
                  maxlength="3"        class="layui-input">
            </div>
        </div>
        <div class="layui-inline">
            <label class="layui-form-label padd_top">外部SKU</label>
            <div class="layui-input-inline">
                <input type="tel" name="productInfo.outSkuCode" class="layui-input"  value="{{if productInfo && productInfo.outSkuCode}}{{:productInfo.outSkuCode}}{{/if}}"  message="外部SKU"
                       autocomplete="off"  maxlength="25"
                 placeholder="请输入外部SKU" class="layui-input ">
            </div>
        </div>
    </div>
    <div class="layui-form-item mizone-form-item">
        <div class="layui-inline">
            <label class="layui-form-label padd_top">排序权重</label>
            <div class="layui-input-inline">
                <input type="text" name="productInfo.sortWeight" lay-verify="num"
                       placeholder="请输入排序权重"  maxlength="8" value="{{if productInfo && productInfo.sortWeight}}{{:productInfo.sortWeight}}{{/if}}" message="排序权重" class="layui-input" autocomplete="off">
            </div>
        </div>
    </div>
  <div class="layui-form-item mizone-form-item" style="display:none">
        <div class="layui-inline">
            <label class="layui-form-label padd_top"><span style="color:red">*</span>采购价格</label>
            <div class="layui-input-inline">
                <input type="tel" name="productInfo.cost"   placeholder="请输入采购价格" value="{{if productInfo && productInfo.cost}}{{:productInfo.cost}}{{/if}}"   message="基本信息的采购价格" required-message="基本信息的采购价格不能为空" autocomplete="off"
                 maxlength="8"      class="layui-input">
            </div>
        </div>

    </div>

    <div class="layui-form-item mizone-form-item">
        <div class="layui-inline">
            <label class="layui-form-label padd_top"><span style="color:red">*</span>会员价</label>
            <div class="layui-input-inline">
                    <input type="checkbox"  id="hasProductMemberPrice" lay-filter="hasProductMemberPrice" readonly="readonly" disabled="disabled" checked="checked" lay-skin="primary"  />
            </div>
        </div>
        <div class="layui-inline input_small_point">
            <label class="layui-form-label padd_top">小车经销商销售积分</label>
            <div class="layui-input-inline">
                <input type="text" name="productInfo.smallPoint" lay-verify="num|agency"   placeholder="请输入小车经销商销售积分"  value="{{if productInfo && productInfo.smallPoint}}{{:productInfo.smallPoint}}{{/if}}"   message="小车经销商销售积分"autocomplete="off"
                   maxlength="8"     class="layui-input">
            </div>
        </div>
    </div>
    <div class="layui-form-item" style="display:none">
        <div class="layui-inline" id="rankLevelList">

        </div>
    </div>
    <div class="layui-form-item mizone-form-item">
        <div class="layui-inline">
            <label class="layui-form-label padd_top">促销信息</label>
            <div class="layui-input-inline">
                <textarea cols="120" rows="4" id="promotionInfo" name="productInfo.promotionInfo">{{if productInfo && productInfo.promotionInfo}}{{:productInfo.promotionInfo}}{{/if}}</textarea>
            </div>
        </div>
    </div>
    <div class="layui-form-item mizone-form-item">
        <div class="layui-inline">
            <label class="layui-form-label padd_top">商品说明</label>
            <div class="layui-input-inline">
                <textarea cols="120" rows="4" id="commodityDescription" name="productInfo.commodityDescription">{{if productInfo && productInfo.commodityDescription}}{{:productInfo.commodityDescription}}{{/if}}</textarea>
            </div>
        </div>
    </div>
</script>

<!--<option value="{{:id}}">{{:name}}({{:categoryNum}})</option>-->
<script type="x-jsrender" id="j-option-category">
      <li class=""><span class="am-selected-text" value="{{:id}}">{{:name}}({{:categoryNum}})</span> <i class="am-check icon-duigou"></i></li>
</script>

<script type="x-jsrender" id="j-option">
    {{for result}}
      <option value="{{:id}}">{{:name}}</option>
    {{/for}}
</script>
<script type="x-jsrender" id="j-option-brand">
    {{for result}}
      <li class=""><span class="am-selected-text" value="{{:id}}">{{:name}}({{:brandNum}})</span> <i class="am-check icon-duigou"></i></li>
      {{/for}}
</script>
<script type="x-jsrender" id="j-option-check">
    {{for result}}
      <input type="checkbox" lay-verify="platform" lay-filter="product_platform"   name="productInfo.platformIdList" code="{{:code}}"  value="{{:id}}" lay-skin="primary" title="{{:name}}" />
    {{/for}}
</script>
<script type="x-jsrender" id="j-spec-check">
    {{for result}}
      <input type="checkbox" name="productSpecificationsInfoList.id"  class="product_spec"   lay-filter="product_spec"   value="{{:id}}" lay-skin="primary" title="{{:name}}" />
    {{/for}}
</script>
<script type="x-jsrender" id="j-spec-value-select">
<td class="layui-form spec_{{:id}}">
       <div class="layui-input-inline">
   <select name="productDetailInfoDTOList.productSpecificationsValueList.id" class="input_select_value" lay-verify="required" lay-search="">
    <option value="">请选择{{:specName}}</option>
      {{for result}}
      <option value="{{:id}}">{{:specificationsValue}}</option>
      {{/for}}
     </select>
     </div>
 </td>
</script>
<script type="x-jsrender" id="j-tag-check">
    {{for result}}
      <input type="checkbox" name="productTagList[{{:#index}}].tagId"    lay-filter="tag_product"  value="{{:id}}" lay-skin="primary" title="{{:name}}" />
    {{/for}}
</script>
<script type="x-jsrender" id="rank_level_tpl">
<label class="layui-form-label"></label>
{{for result}}
{{if #index % 2 == 0}}
<div class="layui-input-inline">
{{/if}}
    <span>{{:name}}:</span>
    <input type="hidden" name="productMemberPriceList[{{:#index}}].rankLevelId" value="{{:id}}" />
    <input type="text" name="productMemberPriceList[{{:#index}}].memberPrice" lay-verify="required" required-message="不能为空" id="price_{{:id}}" autocomplete="off" class="layui-input" style="width: 100px;">
{{if #index % 2 == 1 || #index==size - 1}}
</div>
{{/if}}
{{/for}}
</script>
<script type="x-jsrender" id="j-img">
    <div class="mizone-upload-list">
        <img src="{{:srcUrlImg}}" alt="">
        <input type="hidden" class="id" name="productImgInfoList.id" value="{{:id}}">
        <input type="hidden" class="urlPath" name="productImgInfoList.urlPath" value="{{:src}}">
        <input type="hidden" class="imgThumbnail" name="productImgInfoList.imgThumbnail" value="{{:imgThumbnail}}">
        <input type="hidden" class="imgLarge" name="productImgInfoList.imgLarge" value="{{:imgLarge}}">
        <input type="hidden" class="imgMedium" name="productImgInfoList.imgMedium" value="{{:imgMedium}}">
        <input type="hidden"  class="num" name="productImgInfoList.num"  >
        <div class="mizone-upload-list-cover">
            <i class="layui-icon left">&#xe603;</i>
            <i class="layui-icon right">&#xe602;</i>
            <i class="layui-icon update">&#xe642;</i>
            <i class="layui-icon deleted">&#xe640;</i>
        </div>
    <div>
</script>
<script type="x-jsrender" id="j-spec-value-tr">
  <tr class="tr_add_clone_tr">
    <input type="hidden" class="input_id" name="productDetailInfoDTOList.productDetailInfo.id"/>
      <td class="show_product_detail_id" style="display:none"></td>
    <td>  <input type="text" name="productDetailInfoDTOList.productDetailInfo.skuCodeRandom"
                                       class="layui-input input_sku_code sku_no_verify no_update"  lay-verify="skuNo" message="多规格的"  maxlength="4"    placeholder="请输入sku随机码"></td>
   <td>  <input type="text" name="productDetailInfoDTOList.productDetailInfo.sn"  maxlength="23"
                                       class="layui-input input_sn sn_verify no_update_no_blank" lay-verify="sn"   message="多规格的"  placeholder="请输入商品条码"></td>
    <td class="detail_sale_price_value"> <input type="text"  lay-verify="price"   maxlength="8"   message="多规格销售价格" name="productDetailInfoDTOList.productDetailInfo.price"
                                       class="layui-input input_sale_price"  placeholder="请输入销售单价"></td>
     <td  style="display: none" > <input type="text"name="productDetailInfoDTOList.productDetailInfo.cost"
                                 maxlength="8"         class="layui-input input_cost_price"  message="多规格采购价格" placeholder="采购价格"></td>
     <td class="input_small_point" > <input type="text" name="productDetailInfoDTOList.productDetailInfo.smallPoint"
                                 maxlength="8"      class="layui-input input_small_point_require"   placeholder="小车经销商积分"></td>
    <td><input type="text" name="productDetailInfoDTOList.productDetailInfo.explainInfo"
                               maxlength="100"           class="layui-input input_explain"    placeholder="请输入说明"></td>
    <td><input type="text" name="productDetailInfoDTOList.productDetailInfo.remark"
                                  maxlength="100"       class="layui-input input_remark"    placeholder="请输入备注"></td>
    <td class="state_uhandle">
        <div class="">
            <a class=" update tr_add_clone"  value="{{item.id}}"  >
                <i class="icon-plus2"></i>
            </a>
            <a class="delete tr_delete_clone input_delete" value="{{item.id}}">
                <i class="icon-delete"></i>
            </a>
        </div>
    </td>
</tr>
</script>
<script type="x-jsrender" id="j-spec-tr">
<td class="layui-form spec_{{:id}}">{{:specName}}</td>
</script>
<script type="x-jsrender" id="j-sku-td">
  {{for result}}
       <dd data-id="{{:id}}" class="sku_dd">{{if fullName!=null}}{{:fullName}}{{else}}{{:name}}{{/if}}({{:skuCode}})</dd>

  {{/for}}
</script>

<script charset="utf-8" src="../../common/editor/kindeditor-all-min.js"></script>
<script charset="utf-8" src="../../common/editor/lang/zh-CN.js"></script>
<script type="text/javascript">
    $(window).load(function () {
        var id = Utils.getHrefValue("id");
        if (Utils.isNotBlack(id) && id.length > 0) {
            var imgObj = $(".mizone-upload-list img");
            if (typeof(imgObj) != "undefined") {
                var imgdefereds = [];
                imgObj.each(function () {
                    var dfd = $.Deferred();
                    $(this).bind('load', function () {
                        dfd.resolve();
                    }).bind('error', function () {
                        //图片加载错误，加入错误处理
                        // dfd.resolve();
                    })
                    if (this.complete) setTimeout(function () {
                        dfd.resolve();
                    }, 1000);
                    imgdefereds.push(dfd);
                });
                $.when.apply(null, imgdefereds).done(function () {
                    console.info("img load done........");
                    $(".next_update").show();
                });
            }
        }
    });
    /*创建富文本编辑器*/
    layui.use(['form', 'layer', 'element'], function () {

        var layer = layui.layer;
        var form = layui.form();
        var element = layui.element();
        var brandList = null;
        var categoryList = null;
        var platformList = null;
        var specificationsList = null;
        var tagList = null;
        var rankLevelList = null;
        var map = new Map();
        //小车经销商的平台的编号
        var Small_CAR_CODE = "SCARCONSUMER";
        var updateImg;
        var id = Utils.getHrefValue("id");
        var isCommon = Utils.getHrefValue("isCommon") == 1;
        var isLook = Utils.getHrefValue("type") == "look";
        var productInfo;
        var productTypeSpec = 1;
        var productTypePackage = 2;
        var isLoadProductDetail = true;
        var isLoadPackage = true;
        var categoryNum;
        var brandNum;
        var editor;
        KindEditor.ready(function (K) {
            var height = $(document.body).height() - 150;
            editor = K.create('#com_uploade', {
                width: '100%',
                height: height,
                themeType: "simple",
//                syncType: "form",
//                fillDescAfterUploadImage:true,
                items: [
                    "source", "|", "undo", "redo", "|", "preview", "print", "|", "justifyleft", "justifycenter", "justifyright",
                    "justifyfull", "insertorderedlist", "insertunorderedlist", "indent", "outdent", "subscript",
                    "superscript", "clearhtml", "quickformat", "selectall", "|", "fullscreen", "/",
                    "formatblock", "fontname", "fontsize", "|", "forecolor", "hilitecolor", "bold",
                    "italic", "underline", "strikethrough", "lineheight", "removeformat", "|", "image",
                    "media", "table", "hr", "pagebreak",
                ],
                allowFileManager: true,
                filterMode: false,
                filePostName: "file",
                afterUpload: function (url) {

                },
                afterChange: function () {
                    this.sync();
                },
                uploadJson: "/admin/product/img/html/update.json?isThumbnails=false"
            });
        })

        function previewFile(fun, id) {
            if (!Utils.isNotNull(id)) {
                id = "update_img_data";
            }
            var file = document.getElementById(id).files[0]
            var reader = new FileReader();
            reader.addEventListener("load", function () {
                // console.log(reader.result)
                fun.call(this, reader.result)
            }, false);

            if (file) {
                reader.readAsDataURL(file);
            }
        }

        if (Utils.isNotBlack(id) && id.length > 0) {
            $(".next_close").hide();
            $(".next_update").html("保存并更新")
            $(".next_update").hide();
        }

        function checkSmallCar() {
            var bool = false;
            $("#platform_id input[type='checkbox']").each(function () {
                if (Utils.checkBox($(this), true, false)) {
                    if ($(this).attr("code") == Small_CAR_CODE) {
                        bool = true;
                    }
                }
            })
            return bool;
        }

        $("#cancel").click(function () {
            callParent.openTab("product_page");
            callParent.closeTab("product_add");
        })

        function loadImg() {
            var productImgMap = new Map();
            if (Utils.isNotNull(productInfo) && Utils.isNotNull(productInfo.productImgInfoList) && productInfo.productImgInfoList.length > 0) {
                for (var i = 0; i < productInfo.productImgInfoList.length; i++) {
                    var productImg = productInfo.productImgInfoList[i];
                    var key = productImg.id;
                    if (Utils.isNotNull(productImg.num)) {
                        key = productImg.num;
                    }
                    productImgMap.push(key, {
                        id: productImg.id,
                        num: productImg.num,
                        src: productImg.urlPath,
                        imgThumbnail: productImg.imgThumbnail,
                        imgLarge: productImg.imgLarge,
                        imgMedium: productImg.imgMedium
                    });
                }
                var keyList = productImgMap.keySort();
                for (var i = 0; i < keyList.length; i++) {
                    var key = keyList[i];
                    var productImg = productImgMap.get(key);
                    var jsRenderTpl = $.templates('#j-img');
                    productImg.srcUrlImg = productImg.src;
                    var finalTpl = jsRenderTpl(productImg);
                    $("#mizone-upload-case").before(finalTpl);
                    $("#update_hiden_data").val("");
                    orderImg();
                    imgDeal();
                }
            }
        }

        function change() {
            $("#update_img_data").unbind();
            $("#update_img_data").change(function () {
                if ($.trim($(this).val()) != "") {
                    var $this = $(this);
                    var id = "j-img-" + Utils.uuid(15, 2);
                    var imgLoadImgTemp = $('#j-img-loading');
                    var imgLoadImg = imgLoadImgTemp.clone();
                    imgLoadImg.css("display", "inline-block");
                    imgLoadImg.attr("id", id);
                    $("#mizone-upload-case").before(imgLoadImg);
                    uploadFile("/admin/product/img/update.json", function (dataJson) {
                        previewFile(function (imgUrl) {
                            var jsRenderTpl = $.templates('#j-img');
                            dataJson.data.srcUrlImg = imgUrl;
                            var finalTpl = jsRenderTpl(dataJson.data);
                            imgLoadImg.remove();
                            $("#mizone-upload-case").before(finalTpl);
                            imgDeal();
                            $("#update_img_data").val("");
                            if ($("#upload_send_img .mizone-upload-list img").length == 5) {
                                $("#mizone-upload-case").hide();
                            } else {
                                change();
                            }
                            orderImg();
                        })

                    }, {fileId: "update_img_data", data: {isThumbnails: true, hasRule: true}});
                }
            })
        }

        function changeHideImg() {
            $("#update_hiden_data").unbind();
            $("#update_hiden_data").change(function () {
                if ($.trim($(this).val()) != "") {
                    var $this = $(this);
                    var id = "j-img-" + Utils.uuid(15, 2);
                    var imgLoadImgTemp = $('#j-img-loading');
                    var imgLoadImg = imgLoadImgTemp.clone();
                    imgLoadImg.css("display", "inline-block");
                    imgLoadImg.attr("id", id);
                    updateImg.next().before(imgLoadImg);
                    updateImg.remove();
                    uploadFile("/admin/product/img/update.json", function (dataJson) {

                        previewFile(function (imgUrl) {
                            var jsRenderTpl = $.templates('#j-img');
                            dataJson.data.srcUrlImg = imgUrl;
                            var finalTpl = jsRenderTpl(dataJson.data);
                            $("#update_hiden_data").val("");
                            $("#" + id).next().before(finalTpl);
                            $("#" + id).remove();
                            orderImg();
                            imgDeal();
                            changeHideImg();
                        }, 'update_hiden_data');
                    }, {fileId: "update_hiden_data", data: {isThumbnails: true, hasRule: true}});
                }
            })
        }

        changeHideImg();

        function imgDeal() {
            $(".mizone-upload-list-cover .right").unbind();
            $(".mizone-upload-list-cover .left").unbind();
            $(".mizone-upload-list-cover .update").unbind();
            $(".mizone-upload-list-cover .deleted").unbind();
            $(".mizone-upload-list-cover .update").click(function () {
                updateImg = $(this).parents(".mizone-upload-list");
                $("#update_hiden_data").click();
                orderImg();
            })
            $(".mizone-upload-list-cover .deleted").click(function () {
                $(this).parents(".mizone-upload-list").remove();
                orderImg();

                $("#mizone-upload-case").show();
                change();
            })
            $(".mizone-upload-list-cover .left").click(function () {
                $(this).parents(".mizone-upload-list").prev().before($(this).parents(".mizone-upload-list"))
                orderImg();
                ;
            })
            $(".mizone-upload-list-cover .right").click(function () {
                $(this).parents(".mizone-upload-list").next(".mizone-upload-list").after($(this).parents(".mizone-upload-list"))
                orderImg();
            })
        }

        function orderImg() {
            var i = 0;
            $(".mizone-upload-list .num").each(function () {
                $(this).attr("name", "productImgInfoList[" + i + "].num");
                $(this).val((i + 1));
                i++;
            })
            i = 0;
            $(".mizone-upload-list .urlPath").each(function () {
                $(this).attr("name", "productImgInfoList[" + i + "].urlPath");
                if (i == 0) {
                    $("#product_img_url_path").val($(this).val());
                }
                i++;
            })
            if ($(".mizone-upload-list .urlPath").length == 0) {
                $("#product_img_url_path").val("");

            }
            i = 0;
            $(".mizone-upload-list .id").each(function () {
                $(this).attr("name", "productImgInfoList[" + i + "].id");
                i++;
            })
            i = 0;
            $(".mizone-upload-list .imgThumbnail").each(function () {
                $(this).attr("name", "productImgInfoList[" + i + "].imgThumbnail");
                i++;
            })
            i = 0;
            $(".mizone-upload-list .imgLarge").each(function () {
                $(this).attr("name", "productImgInfoList[" + i + "].imgLarge");
                i++;
            })
            i = 0;
            $(".mizone-upload-list .imgMedium").each(function () {
                $(this).attr("name", "productImgInfoList[" + i + "].imgMedium");
                i++;
            })
        }

        function showHideSmallCar() {
            if (checkSmallCar()) {
                $(".input_small_point").each(function () {
                    $(".input_small_point_require").attr("lay-verify", "num|agency");
                })
                $(".input_small_point").show();
            } else {
                $(".input_small_point").each(function () {
                    $(".input_small_point_require").removeAttr("lay-verify");
                })
                $(".input_small_point").hide();
            }
        }

        form.on("submit(form_submit_close)", function () {
            var that = $(this);
            submitForm(that)
        })
        form.on("submit(form_submit_update)", function () {
            var that = $(this);
            submitForm(that)
        });

        function submitForm(that) {
            var i = 0;
            $("#spec_id").find(".product_spec").each(function () {
                if (Utils.checkBox($(this), true, false)) {
                    $(this).attr("name", "productSpecificationsInfoList[" + i + "].id");
                    i++;
                }
            });
            $(".no_update").removeAttr("disabled");
            $(".no_update_no_blank").removeAttr("disabled");
            /* var content = layedit.getContent(editIndex)
             $("#com_uploade").html(content);*/
//            editor.html(content);
            var url = "/admin/product/save/space.json";
            var loadUrl = "admin/commodity/add_com_ckj.html?";
            var title = "商品";
            if (isCommon) {
                url = "/admin/product/save_common/space.json";
                loadUrl = "admin/commodity/add_com_ckj.html?isCommon=1";
                title = "公共商品";
            }
            $("#brand_id_value").val(getSelectLiId("brand_id"));
            $("#category_id_value").val(getSelectLiId("category_id"));
            if (!$("#hasProductMemberPrice").attr('checked')) {
                $("#rankLevelList").empty();
            }
            var content = $("#form_edit").serialize();
            content += "&productInfo.productDesc=" + encodeURIComponent($("#com_uploade").val());
            /*console.log(layedit.getText("com_uploade"));*/
            ajaxsend(content, url, function (dataJson) {
                if ($.trim($("#product_id").val()) == "") {
                    layer.alert("新增成功", function () {
                        callParent.parentUse("product_page", "search");
                        if (that.hasClass("next_close")) {
                            callParent.openTab("product_page");
                            callParent.closeTab("product_add");
                        } else {
                            callParent.openTab("product_add", 0, "新增" + title, loadUrl + "&rand=" + new Date().getTime(), true);
                        }

                    });
                } else {
                    layer.alert("修改成功", {
                        time: 2000,
                        btn: '',
                        end: function (index) {
                            callParent.parentUse("product_page", "search");
                            /*layer.close(index);*/
                            callParent.openTab("product_add", 0, "修改" + title, loadUrl + "&id=" + id + "&rand=" + new Date().getTime(), true);
                        }
                    });
                }
            }, "postForm", undefined, function () {

            });
            closeUpdate();
        }

        form.on("radio(spec_package_radio)", function (data) {
            productTypeSelect($(this).val())
        });
        var formStatus = true;
        $(".form_submit").click(function () {
            formDateTime = new Date();
            formStatus = false;
        });

        function getSelectLiId(id) {
            var idList = new Array();
            $("#" + id).find("li").each(function () {
                if ($(this).hasClass("am-checked")) {
                    idList.push($(this).find("span").attr("value"))
                }
            })
            if (idList.length > 0) {
                return idList[0];
            }
            return "";
        }

        function productTypeSelect(val) {
            if (val == 1) {
                $(".sepc_select").show();
                $(".package_select").hide();
                $(".package_add_clone_tr .sku_input").removeAttr("lay-verify")
            } else if (val == 2) {
                $(".package_select").show();
                $(".sepc_select").hide();
                $(".package_add_clone_tr .sku_input").attr("lay-verify", "package")
            }
        }

        var formDateTime = null;
        form.verify({
            selectBrandId: function () {
                var brandId = getSelectLiId("brand_id");
                if (!Utils.isNotNull(brandId) || brandId.length == 0) {
                    return "品牌不能为空！";
                }
            },
            selectCategoryId: function () {
                var categoryId = getSelectLiId("category_id");
                if (!Utils.isNotNull(categoryId) || categoryId.length == 0) {
                    return "分类不能为空！";
                }
            },
            length: function (value, item) {
                var maxlength = $(item).attr("maxlength")
                if (Utils.isNotBlack(value)) {
                    if (value.length > maxlength) {
                        return "最长不能超过" + maxlength;
                    }
                }
            },
            skuFirstCategory: function () {
                var bool = false;
                if (Utils.checkBox($("#category_first_ckj"), true, false)) {
                    bool = true;
                }
                if (Utils.checkBox($("#category_first_oem"), true, false)) {
                    bool = true;
                }
                if (Utils.checkBox($("#category_first_qdk"), true, false)) {
                    bool = true;
                }
                if (!bool) {
                    return "请选择SKU分类品台";
                }
            },
            img: function (value) {
                if (value.indexOf("data:image/jpeg;base64") >= 0) {
                    return "不能复制图片，只能通过上传图片！";
                }
                return "";
            },
            required: function (value, item) {
                var result = "";
                if (!Utils.isNotBlack($.trim(value))) {
                    result = $(item).attr("required-message");
                    if (!Utils.isNotBlack(result)) {
                        result = "必选项不能为空";
                    }
                }
                return result;
            },
            productImg: function () {
                if ($("#upload_send_img .mizone-upload-list img").length == 0) {
                    //   return "商品图片不能少于一张！"
                }
            },
            price: function (value, item) {
                var message = $(item).attr("message")
                if (!Utils.isNotNull(message)) {
                    message = "";
                }
                if (!Utils.checkPrice(value)) {
                    return message + '价格格式不正确';
                }
            },
            decimal: function (value, item) {
                var message = $(item).attr("message")
                if (!Utils.isNotNull(message)) {
                    message = "";
                }
                if (Utils.isNotBlack(value)) {
                    if (!/^(([0-9])|([1-9][0-9]+)|([0-9]+\.[0-9]+))$/.test(value)) {
                        return message + '必须为正数';
                    }
                }
            },
            num: function (value, item) {
                var message = $(item).attr("message")
                if (!Utils.isNotNull(message)) {
                    message = "";
                }
                if (Utils.isNotBlack(value)) {
                    if (!/^(([0-9])|([1-9][0-9]+))$/.test(value)) {
                        return message + '必须为正整数';
                    }
                }
            },
            sn: function (value, item) {
                var result = "";
                var message = $(item).attr("message")
                if (!Utils.isNotNull(message)) {
                    message = "";
                }
                if (Utils.isNotBlack(value)) {
                    var valList = new Array();
                    var num = 0;
                    $(".sn_verify").each(function () {
                        if (Utils.isNotBlack($(this).val())) {
                            if ($.trim(value) == $.trim($(this).val())) {
                                num++;
                            }
                        }
                    });
                    if (num > 1 && $(item).hasClass("sn_verify")) {
                        return message + "商品条码与其他商品条码不能重复！";
                    }
                    if (!/^([a-zA-z0-9]|[-/])+$/.test(value)) {
                        return message + "商品条码只能有字符和数字以及(-/)组成！"
                    }
                    ajaxsend({
                        sn: value,
                        productId: $("#product_id").val(),
                        isCommon: isCommon
                    }, "/admin/product/checkSn.json", function (dataJson) {
                        formDateTime = new Date().getTime();
                        if (!dataJson.result) {
                            result = message + "商品条码与后台重复！";
                        }
                    }, "get", false);
                }
                return result;
            },
            package: function (value, item) {
                if (!$(".package_select").is(":hidden")) {
                    if (!Utils.isNotBlack(value)) {
                        return "套餐的选择的商品不能为空";
                    }
                }
                return;
            },
            platform: function (value, item) {
                var bool = false;
                $("#platform_id input[type='checkbox']").each(function () {
                    if (Utils.checkBox($(this), true, false)) {
                        bool = true;
                    }
                })
                if (!bool) {
                    return "上架平台不能为空！";
                }
            },
            agency: function (value, item) {
                var bool = checkSmallCar();
                if (bool) {
                    if ($.trim(value) == "") {
                        return "小车经销商积分不能为空！";
                    }
                }
            },
            skuNo: function (value, item) {
                var result = "";
                var message = $(item).attr("message");
                if (!Utils.isNotBlack(message)) {
                    message = "";
                }
                if ($(".sku_no_verify,.pre_sku_no_verify").length == 1) {
                    if (Utils.isBlank(value)) {
                        return;
                    }
                }
                if ($(item).hasClass("product_sku_code") || $(item).hasClass("input_sku_code")) {
                    if (Utils.isBlank(value)) {
                        return;
                    }
                }
                if (Utils.isNotBlack(value)) {
                    value = getSkuCode(value);
                    var valList = new Array();
                    var num = 0;
                    $(".sku_no_verify").each(function () {
                        if (Utils.isNotBlack($(this).val())) {
                            if ($.trim(value) == $.trim($(this).val())) {
                                num++;
                            }
                        }
                    });
                    if (num > 1 && $(item).hasClass("input_sku_code")) {
                        return "该" + message + "SKU编码与其他SKU编码不能重复！";
                    }
                    if (!/^([a-zA-z0-9]|[-/])+$/.test(value)) {
                        return message + "SKU编码只能有字符和数字以及(-/)组成！"
                    }
                    ajaxsend({
                        skuCode: value,
                        productId: $("#product_id").val(),
                        isCommon: isCommon
                    }, "/admin/product/checkSkuCode.json", function (dataJson) {
                        formDateTime = new Date().getTime();
                        if (!dataJson.result) {
                            result = message + "SKU编码与后台重复！";
                        }
                    }, "get", false);
                }
                return result;
            },
            /*customCodeCheck:function (value, item) {
                var result = "";
                // var message = $(item).attr("message");
                // if (!Utils.isNotBlack(message)) {
                //     message = "";
                // }
                if (Utils.isNotBlack(value)) {
                    if (!/^[0-9]*$/.test(value)) {
                        return "商品编码必须为数字";
                    }

                    ajaxsend({
                        customCode: value,
                        productId: $("#product_id").val(),
                        isCommon: isCommon
                    }, "/admin/product/checkCustomCode.json", function (dataJson) {
                        formDateTime = new Date().getTime();
                        if (!dataJson.result) {
                            result =  "商品编码已经存在！";
                        }
                    }, "get", false);
                }

                return result;
            }*/
        });

        /**
         * 添加分类，品牌，以及其他基础数据
         */
        function getList(url, fun, list, data) {
            if (Utils.isNotNull(list) && list.length > 0) {
                fun.call(this, {result: list});
            } else {
                if (!Utils.isNotNull(data)) {
                    data = {};
                }
                ajaxsend(data, url, function (dataJson) {
                    fun.call(this, dataJson);
                })
            }
        }

        function closeUpdate() {
            if (Utils.isNotNull(productInfo) && Utils.isNotNull(productInfo.productInfo) && Utils.isNotNull(productInfo.productInfo.isRevise) && productInfo.productInfo.isRevise) {
                $(".no_update").attr("disabled", "disabled");
                $(".no_update_no_blank").each(function () {
                    if (Utils.isNotBlack($.trim($(this).val()))) {
                        $(this).attr("disabled", "disabled");
                    }

                });
            }
        }

        function isClose() {
            return (Utils.isNotNull(productInfo) && Utils.isNotNull(productInfo.productInfo) && Utils.isNotNull(productInfo.productInfo.isRevise) && productInfo.productInfo.isRevise);
        }

        function loadInfo() {
            if (Utils.isNotBlack(id)) {
                getList("/admin/product/info.json", function (dataJson) {
                    productInfo = dataJson.result;
                    if (Utils.isNotNull(productInfo) && Utils.isNotNull(productInfo.productDetailInfoBoList) && productInfo.productDetailInfoBoList.length > 0) {
                        for (var i = 0; i < productInfo.productDetailInfoBoList.length; i++) {
                            if (productInfo.productInfo.skuCode == productInfo.productDetailInfoBoList[i].productDetailInfo.skuCode) {
                                productInfo.productInfo.detailId = productInfo.productDetailInfoBoList[i].productDetailInfo.id;
                                break;
                            }
                        }
                    }
                    loadProductInfo(dataJson);
//                    $("#com_uploade").html(productInfo.productInfo.productDesc);
                    editor.html(productInfo.productInfo.productDesc)
//                    loadEdit()
                    closeUpdate();
                    loadImg();
                    loadProductType();
                    loadProductDetail();
                    loadPackageInfo();
                    loadChecked("marketable");
                    loadChecked("gift");
                    loadChecked("enabled");
                    if (isLook) {
                        $(".form_submit").hide();
                        $("input").attr("disabled", "disabled");
                        $("select").attr("disabled", "disabled");
                        $("textarea").attr("disabled", "disabled");
                    }
                    form.render();
                    submitCheck()
                    showHideSmallCar();
                }, undefined, {productId: id});
            } else {
                loadProductInfo({result: {}});
//                loadEdit()
                submitCheck();
            }
            showHideSmallCar();
        }

        function submitCheck() {
            $("form").submit(function () {
                if ($(this).attr("id") != "form_edit") {
                    formStatus = true;
                }
                if (Utils.isNotBlack(formDateTime) && new Date().getTime() - formDateTime > 500) {
                    formStatus = true;
                }
                return formStatus;
            });
        }

        function loadProductType() {
            if (Utils.isNotNull(productInfo) && Utils.isNotNull(productInfo.productInfo.productType)) {
                $(".product_type input[type='radio']").each(function () {
                    if ($(this).val() == productInfo.productInfo.productType) {
                        $(this).attr("checked", "checked");
                        productTypeSelect($(this).val())
                        loadSpecifialClick();
                    }
                })
            }
        }

        function loadSpecifialClick() {
            if (Utils.isNotNull(productInfo) && Utils.isNotNull(productInfo.productInfo.productType)) {
                if (productInfo.productInfo.productType == productTypeSpec) {
                    if (Utils.isNotNull(productInfo.productSpecificationsInfoList) && productInfo.productSpecificationsInfoList.length > 0) {
                        var specificationsIdList = new Array();
                        for (var i = 0; i < productInfo.productSpecificationsInfoList.length; i++) {
                            var productSpecificationsInfo = productInfo.productSpecificationsInfoList[i];
                            specificationsIdList.push(productSpecificationsInfo.id);
                        }
                        $("#spec_id input[type='checkbox']").each(function () {
                            if (Utils.isContain(specificationsIdList, $(this).val())) {
                                $(this).attr("checked", "checked");
                                $(this).addClass("no_update");
                                productSpecLoad($(this), true);
                            }
                        })
                        closeUpdate();
                    }
                }
            }
        }

        function getCodeRandom(skuCode, categoryFirstNum, categoryNum, brandNum) {
            var skuPre = "";
            if (Utils.isNotBlack(categoryFirstNum)) {
                skuPre += categoryFirstNum;
            }
            if (Utils.isNotBlack(categoryNum)) {
                skuPre += categoryNum;
            }
            if (Utils.isNotBlack(brandNum)) {
                skuPre += brandNum;
            }
            if (skuCode.indexOf(skuPre) == 0) {
                return skuCode.substr(skuPre.length);
            }

            return skuCode;
        }

        function getSkuCode(value) {
            var skuCode = "";
            if (Utils.checkBox($("#category_first_ckj"), true, false)) {
                skuCode = $("#category_first_ckj").val();
            } else if (Utils.checkBox($("#category_first_oem"), true, false)) {
                skuCode = $("#category_first_oem").val();
            } else if (Utils.checkBox($("#category_first_qdk"), true, false)) {
                skuCode = $("#category_first_qdk").val();
            }
            if (Utils.isNotNull(categoryList)) {
                var categoryMap = new Map();
                for (var i = 0; i < categoryList.length; i++) {
                    categoryMap.push(categoryList[i].id, categoryList[i]);
                }
                var categoryId = getSelectLiId("category_id");
                skuCode += getCategoryNum(categoryMap, categoryId);
            }
            if (Utils.isNotNull(brandList)) {
                var brandMap = new Map();
                for (var i = 0; i < brandList.length; i++) {
                    brandMap.push(brandList[i].id, brandList[i]);
                }
                var brandInfo = brandMap.get(getSelectLiId("brand_id"));
                if (Utils.isNotNull(brandInfo)) {
                    skuCode += brandInfo.brandNum
                }
            }
            skuCode += value;
            return skuCode;
        }

        function getCategoryNum(categoryMap, categoryId) {
            var categoryInfo = categoryMap.get(categoryId);
            if (Utils.isNotNull(categoryInfo)) {
                if (Utils.isNotBlack(categoryInfo.parentId)) {
                    return getCategoryNum(categoryMap, categoryInfo.parentId);
                } else {
                    return categoryInfo.categoryNum;
                }
            }
        }

        //加载商品基础信息
        function loadProductInfo(dataJson) {
            if (Utils.isNotNull(dataJson.result) && Utils.isNotNull(dataJson.result.productInfo) && Utils.isNotNull(dataJson.result.productInfo.skuCode)) {
                dataJson.result.productInfo.skuCodeRandom = getCodeRandom(dataJson.result.productInfo.skuCode, dataJson.result.productInfo.categoryFirstNum, dataJson.result.productInfo.categoryNum, dataJson.result.productInfo.brandNum);
                $("#product_id_show").html($("#product_id_show").html() + "(" + dataJson.result.productInfo.detailId + ")")
            }
            //取html内容
            var jsRenderTpl = $.templates('#j-index'),
                finalTpl = jsRenderTpl(dataJson.result);
            $("#index_div_id").append(finalTpl);
            form.render();
            form.on("checkbox(product_isMarketable)", function () {
                if (Utils.checkBox($("#product_isMarketable"), true, false)) {
                    $("#product_isEnabled").each(function (index, item) {
                        item.checked = true;
                    });
                    form.render('checkbox');
                }
            });
            form.on("checkbox(product_isEnabled)", function () {
                if (Utils.checkBox($(this), false, true)) {
                    $("#product_isMarketable").removeAttr("checked");
                    form.render('checkbox');
                }
            });
            loadBaseData();
            $("#rankLevelList").parent().show();
            var tempProductInfo = dataJson.result.productInfo;
            if (!Utils.isNotNull(tempProductInfo) || !(Utils.isNotNull(tempProductInfo.isRevise) && tempProductInfo.isRevise && (tempProductInfo.productType == 1 || tempProductInfo.productType == 2))) {
                $("#product_info_product_type_spec").removeClass("no_update");
            }
            /*form.on("checkbox(hasProductMemberPrice)",function(){
            	if(Utils.checkBox( $(this),true,false)){
            		$("#hasProductMemberPrice").attr("checked","checked");
                    $("#rankLevelList").parent().show();
                }else{
                	$("#hasProductMemberPrice").removeAttr("checked");
                    $("#rankLevelList").parent().hide();
                }
                form.render('checkbox');
            });*/
        }

        function selectChecked(list, $this) {
            if (Utils.isNotNull(list) && list.length > 0) {
                $this.find("input[type='checkbox']").each(function () {
                    if (Utils.isContain(list, $(this).val())) {
                        $(this).attr("checked", "checked");
                    }
                })
            }
            form.render();
        }

        function loadChecked(type) {
            if (Utils.isNotNull(productInfo)) {
                if (type == "tag" && Utils.isNotNull(productInfo.tagIdList)) {
                    selectChecked(productInfo.tagIdList, $("#tag_info_list"))
                } else if (type == "platformId" && Utils.isNotNull(productInfo.platformIdList)) {
                    selectChecked(productInfo.platformIdList, $("#platform_id"))
                } else if (type == "marketable" && Utils.isNotNull(productInfo.productInfo.isMarketable) && productInfo.productInfo.isMarketable) {
                    $("#product_isMarketable").attr("checked", "checked");
                } else if (type == 'gift' && Utils.isNotNull(productInfo.productInfo.isGift) && productInfo.productInfo.isGift) {
                    $("#product_isGift").attr("checked", "checked");
                } else if (type == "enabled" && Utils.isNotNull(productInfo.productInfo.isEnabled) && productInfo.productInfo.isEnabled) {
                    $("#product_isEnabled").attr("checked", "checked");
                }
            }
        }

        function addBlanck(result) {
            var resultMap = new Map();
            var categoryMap = new Map();
            for (var i = 0; i < result.length; i++) {
                resultMap.push(result[i].id, {category: result[i], child: new Array()});
                categoryMap.push(result[i].id, result[i]);
            }
            var categoryList = new Array();
            var resultList = new Array();
            for (var i = 0; i < resultMap.key().length; i++) {
                var key = resultMap.key()[i];
                var category = resultMap.get(key);
                category.category.categoryNum = getCategoryNum(categoryMap, category.category.id);
                if (Utils.isNotNull(category.category.parentId)) {
                    var parentCategory = resultMap.get(category.category.parentId)
                    parentCategory.child.push(category);
                } else {
                    resultList.push(category)
                }
            }
            return addChildBlankMark(resultList, "");
        }

        function createOption(resultList) {
            var optHtml = "";
            var jsRenderTpl = $.templates('#j-option-category');
            for (var i in resultList) {
                finalTpl = jsRenderTpl(resultList[i]);
                optHtml += finalTpl;
                if (Utils.isNotNull(resultList[i].childList) && resultList[i].childList.length > 0) {
                    optHtml += "<optgroup>";
                    optHtml += createOption(resultList[i].childList);
                    optHtml += "</optgroup>";
                }
            }
            return optHtml;
        }

        function addChildBlankMark(resultList, mark) {
            var categoryList = new Array();
            for (var i = 0; i < resultList.length; i++) {
                resultList[i].category.name = mark + resultList[i].category.name
                categoryList.push(resultList[i].category);
                if (resultList[i].child.length > 0) {
                    var tempList = addChildBlankMark(resultList[i].child, mark + "&nbsp;&nbsp;&nbsp;");
                    for (var j = 0; j < tempList.length; j++) {
                        categoryList.push(tempList[j]);
                    }

                }
            }
            return categoryList;

        }

        function selectClickLi(id, value) {
            $("#" + id).find("li").each(function (e) {
                if ($(this).find("span").attr("value") == value) {
                    checkedLi(e, $(this))
                }
            })

        }

        function loadBaseData() {
            getList("/admin/common/tag/list.json", function (dataJson) {
                tagList = dataJson.result;
                var jsRenderTpl = $.templates('#j-tag-check'),
                    finalTpl = jsRenderTpl(dataJson);
                $("#tag_info_list").append(finalTpl);
                loadChecked("tag");
                form.render();
            }, tagList, {type: 0, isCommon: isCommon});

            getList("/admin/common/rank_level/list.json", function (dataJson) {
                rankLevelList = dataJson.result;
                for (var item in dataJson.result) {
                    dataJson.result[item].size = dataJson.result.length;
                }
                var jsRenderTpl = $.templates('#rank_level_tpl'),
                    finalTpl = jsRenderTpl(dataJson);
                $("#rankLevelList").append(finalTpl);
                form.render();
                loadProductMemberPrice();
            }, rankLevelList, "");

            getList("/admin/common/brand/list.json", function (dataJson) {
                brandList = dataJson.result;
                var jsRenderTpl = $.templates('#j-option-brand'),
                    finalTpl = jsRenderTpl(dataJson);
                $("#brand_id").append(finalTpl);
                var val = $("#brand_id").attr("value");
                $("#brand_id").removeAttr("value");
                $("#brand_id").val(val);
                form.render();
                $('#am-selected').selectMy({multiselect: false, isClose: isClose()});
                selectClickLi("brand_id", $("#brand_id_value").val());

            }, brandList, {isCommon: isCommon});
            getList("/admin/common/category/list.json", function (dataJson) {
                categoryList = dataJson.result;
                $("#category_id").append(createOption(addBlanck(categoryList)));
                var val = $("#category_id").attr("value");
                $("#category_id").removeAttr("value");
                $("#category_id").val(val);
                form.render();
                $('#am-selected-category_id').selectMy({multiselect: false, isClose: isClose()});
                selectClickLi("category_id", $("#category_id_value").val())

            }, categoryList, {isCommon: isCommon});
            getList("/admin/common/platform/list.json", function (dataJson) {
                platformList = dataJson.result;
                var jsRenderTpl = $.templates('#j-option-check'),
                    finalTpl = jsRenderTpl(dataJson);
                $("#platform_id").append(finalTpl);
                var i = 0;
                $("#platform_id  input[type='checkbox']").each(function () {
                    $(this).attr("name", "platformIdList[" + i + "]");
                    i++;
                })
                loadChecked("platformId");
                form.render();
                form.on("checkbox(product_platform)", function () {
                    showHideSmallCar();
                })
            }, platformList, "");
            getList("/admin/common/specifications/list.json", function (dataJson) {
                specificationsList = dataJson.result;
                var jsRenderTpl = $.templates('#j-spec-check'),
                    finalTpl = jsRenderTpl(dataJson);
                $("#spec_id").append(finalTpl);
                form.render();
                form.on('checkbox(product_spec)', function (data) {
                    productSpecLoad($(data.elem), data.elem.checked);
                });
                loadSpecifialClick();
            }, specificationsList, {isCommon: isCommon})
        }

        function productSpecLoad($checkObj, checked) {
            if ($("#detail_tbody tr").length == 0) {
                var jsRenderTpl = $.templates('#j-spec-value-tr'),
                    finalTpl = jsRenderTpl(valueData);
                $("#detail_tbody").append(finalTpl)
                if (Utils.isNotNull(productInfo) && Utils.isNotNull(productInfo.productInfo.isRevise) && productInfo.productInfo.isRevise) {
                    var tempProductDetailInfoBoList = new Array();
                    if (Utils.isNotNull(productInfo.productDetailInfoBoList) && productInfo.productDetailInfoBoList.length == 0) {
                        tempProductDetailInfoBoList.concat({
                            productDetailInfo: {
                                skuCode: productInfo.productInfo.skuCode,
                                sn: productInfo.productInfo.sn,
                                price: productInfo.productInfo.price,
                                smallPoint: productInfo.productInfo.smallPoint,
                                cost: productInfo.productInfo.cost,
                                explainInfo: productInfo.productInfo.explainInfo,
                                remark: productInfo.productInfo.remark
                            }
                        });
                    } else {
                        tempProductDetailInfoBoList = tempProductDetailInfoBoList.concat(productInfo.productDetailInfoBoList);
                    }
                    if (tempProductDetailInfoBoList.length > 0) {
                        var tempProductDetailBo = tempProductDetailInfoBoList[0];
                        var tempProductDetailTr = $("#detail_tbody tr");
                        var skuRandomCode = getCodeRandom(tempProductDetailBo.productDetailInfo.skuCode, productInfo.productInfo.categoryFirstNum, productInfo.productInfo.categoryNum, productInfo.productInfo.brandNum)
                        tempProductDetailTr.find(".input_sku_code").val(skuRandomCode);
                        tempProductDetailTr.find(".input_sn").val(tempProductDetailBo.productDetailInfo.sn);
                        tempProductDetailTr.find(".input_sale_price").val(tempProductDetailBo.productDetailInfo.price);
                        tempProductDetailTr.find(".input_small_point_require").val(tempProductDetailBo.productDetailInfo.smallPoint);
                        tempProductDetailTr.find(".input_cost_price").val(tempProductDetailBo.productDetailInfo.cost);
                        tempProductDetailTr.find(".input_explain").val(tempProductDetailBo.productDetailInfo.explainInfo);
                        tempProductDetailTr.find(".input_remark").val(tempProductDetailBo.productDetailInfo.remark);
                        tempProductDetailTr.find(".tr_delete_clone").addClass("no_update");
                        closeUpdate();
                    }
                }
                showHideSmallCar();
                specAddTrBind();
                specDeleTrBind();
            }
            var productSpec = $checkObj;
            var paramter = {id: productSpec.val(), specName: productSpec.attr("title")}
            if (checked) {
                var jsRenderTpl = $.templates('#j-spec-tr'),
                    finalTpl = jsRenderTpl(paramter);
                $("#detail_sale_price").before(finalTpl);
                var valueList = map.get(productSpec.val());
                if (Utils.isNotNull(valueList) && valueList.length > 0) {
                    var valueData = {
                        result: valueList,
                        id: productSpec.val(),
                        specName: productSpec.attr("title")
                    };
                    var jsRenderTpl = $.templates('#j-spec-value-select'),
                        finalTpl = jsRenderTpl(valueData);
                    $(".detail_sale_price_value").before(finalTpl)
                    form.render();
                    specOrderName();
                } else {
                    ajaxsend({
                        id: productSpec.val(),
                        isCommon: isCommon
                    }, "/admin/common/specifications/value/list.json", function (dataJson) {
                        map.push(productSpec.val(), dataJson.result);
                        var valueData = {
                            result: dataJson.result,
                            id: productSpec.val(),
                            specName: productSpec.attr("title")
                        };
                        var jsRenderTpl = $.templates('#j-spec-value-select'),
                            finalTpl = jsRenderTpl(valueData);
                        $(".detail_sale_price_value").before(finalTpl)
                        form.render();
                        specOrderName();
                        loadProductDetail();
                    })
                }
            } else {
                /**
                 * 有没有选择规格，如果没有则去掉
                 * @type {boolean}
                 */
                var bool = false;
                $("#spec_id").find(".product_spec").each(function (i, item) {
                    if (item.checked) {
                        bool = true;
                    }
                });
                if (!bool) {
                    $("#detail_tbody").html("");
                }
                $(".spec_" + productSpec.val()).remove();
            }
            form.render('checkbox');
            loadProductDetail();

        }

        function specAddTrBind() {
            $(".tr_add_clone").unbind()
            $(".tr_add_clone").click(function () {
                var trAddClone = $($(".tr_add_clone_tr")[0]).clone();
                $(trAddClone).find(".show_product_detail_id").html("");
                $(trAddClone).find("select").val("");
                $(trAddClone).find("input").val("");
                $(trAddClone).find(".input_delete").removeClass("no_update")
                $(trAddClone).find(".input_delete").removeAttr("disabled");
                $(trAddClone).find(".input_sku_code").removeAttr("disabled");
                $(trAddClone).find(".input_sn").removeAttr("disabled");
                $("#detail_tbody").append(trAddClone)
                form.render();
                specOrderName();
                specAddTrBind();
                specDeleTrBind();
            })
        }

        function specDeleTrBind() {
            $(".tr_delete_clone").unbind()
            $(".tr_delete_clone").click(function () {
                if ($(this).attr("disabled") != "disabled") {
                    if ($(".tr_add_clone_tr").length > 1) {
                        $(this).parents(".tr_add_clone_tr").remove();
                    }
                    specOrderName();
                }
            })
        }

        function loadProductDetail() {
            if (isLoadProductDetail && Utils.isNotNull(productInfo) && productInfo.productInfo.productType == productTypeSpec && Utils.isNotNull(productInfo.productSpecificationsInfoList) && productInfo.productSpecificationsInfoList.length > 0 && map.key().length >= productInfo.productSpecificationsInfoList.length) {
                var detailLength = productInfo.productDetailInfoBoList.length;
                for (var i = 1; i < detailLength; i++) {
                    $(".tr_add_clone").eq(0).click();
                }
                for (var i = 0; i < productInfo.productDetailInfoBoList.length; i++) {
                    var productDetailInfoBo = productInfo.productDetailInfoBoList[i];
                    var productDetailTr = $(".tr_add_clone_tr").eq(i);
                    var skuRandom = getCodeRandom(productDetailInfoBo.productDetailInfo.skuCode, productInfo.productInfo.categoryFirstNum, productInfo.productInfo.categoryNum, productInfo.productInfo.brandNum)
                    productDetailTr.find(".input_id").val(productDetailInfoBo.productDetailInfo.id);
                    productDetailTr.find(".show_product_detail_id").html(productDetailInfoBo.productDetailInfo.id);
                    productDetailTr.find(".input_sku_code").val(skuRandom);
                    productDetailTr.find(".input_sn").val(productDetailInfoBo.productDetailInfo.sn);
                    productDetailTr.find(".input_sale_price").val(productDetailInfoBo.productDetailInfo.price);
                    productDetailTr.find(".input_small_point_require").val(productDetailInfoBo.productDetailInfo.smallPoint);
                    productDetailTr.find(".input_cost_price").val(productDetailInfoBo.productDetailInfo.cost);
                    productDetailTr.find(".input_explain").val(productDetailInfoBo.productDetailInfo.explainInfo);
                    productDetailTr.find(".input_remark").val(productDetailInfoBo.productDetailInfo.remark);
                    /**
                     * 选择对应的规格的信息
                     */
                    var specValueInfoList = productDetailInfoBo.productSpecificationsValueList;
                    var specValueIdList = new Array();
                    for (var j = 0; j < specValueInfoList.length; j++) {
                        specValueIdList.push(specValueInfoList[j].specialtionsValueId);
                    }
                    productDetailTr.find(".input_select_value").each(function () {
                        var $this = $(this);
                        $(this).find("option").each(function () {
                            if (Utils.isContain(specValueIdList, $(this).val())) {
                                $this.val($(this).val());
                            }
                        })
                    });
                    productDetailTr.find(".input_delete").addClass("no_update");
                }
                closeUpdate();
                form.render();
                isLoadProductDetail = false;
                $(".show_product_detail_id").show();
            }
        }

        function loadProductMemberPrice() {
            if (Utils.isNotNull(productInfo) && Utils.isNotNull(productInfo.productMemberPriceList) && productInfo.productMemberPriceList.length > 0) {
                var priceList = productInfo.productMemberPriceList;
                for (var index in priceList) {
                    $("#price_" + priceList[index].rankLevelId).val(priceList[index].memberPrice);
                }
                closeUpdate();
                form.render();
                $("#hasProductMemberPrice").attr("checked", "checked");
                $("#rankLevelList").parent().show();
            }
        }

        function loadPackageInfo() {
            if (isLoadPackage && Utils.isNotNull(productInfo) && productInfo.productInfo.productType == productTypePackage && Utils.isNotNull(productInfo.productPackageList) && productInfo.productPackageList.length > 0) {
                var packageList = productInfo.productPackageList.length;
                for (var i = 1; i < packageList; i++) {
                    addPackageClone()
                }
                var i = 0;
                $(".package_add_clone_tr").each(function () {
                    writePackageDatail($(this), productInfo.productPackageList[i]);
                    i++;
                })
                isLoadPackage = false;
                closeUpdate();
            }
        }

        function specOrderName() {
            var i = 0;
            $(".tr_add_clone_tr").each(function () {
                $(this).find(".input_id").each(function () {
                    $(this).attr("name", "productDetailInfoDTOList[" + i + "].productDetailInfo.id");
                })
                $(this).find(".input_sku_code").each(function () {
                    $(this).attr("name", "productDetailInfoDTOList[" + i + "].productDetailInfo.skuCodeRandom");
                })
                $(this).find(".input_sn").each(function () {
                    $(this).attr("name", "productDetailInfoDTOList[" + i + "].productDetailInfo.sn");
                })

                $(this).find(".input_sale_price").each(function () {
                    $(this).attr("name", "productDetailInfoDTOList[" + i + "].productDetailInfo.price");
                });

                $(this).find(".input_small_point_require").each(function () {
                    $(this).attr("name", "productDetailInfoDTOList[" + i + "].productDetailInfo.smallPoint");
                });
                $(this).find(".input_cost_price").each(function () {
                    $(this).attr("name", "productDetailInfoDTOList[" + i + "].productDetailInfo.cost");
                });
                $(this).find(".input_explain").each(function () {
                    $(this).attr("name", "productDetailInfoDTOList[" + i + "].productDetailInfo.explainInfo");
                })
                $(this).find(".input_remark").each(function () {
                    $(this).attr("name", "productDetailInfoDTOList[" + i + "].productDetailInfo.remark");
                })
                var j = 0;
                $(this).find(".input_select_value").each(function () {
                    $(this).attr("name", "productDetailInfoDTOList[" + i + "].productSpecificationsValueList[" + j + "].id");
                    j++;
                })
                i++;
            })
        }

        function packageAddTrBind() {
            $(".up_num").unbind();
            $(".up_num").click(function () {
                var numObj = $(this).parents(".mizone-input-number").find(".package_product_num");
                if (Utils.isNotNull($.trim(numObj.val())) && numObj.attr("disabled") != "disabled") {
                    numObj.val(numObj.val() - 0 + 1);
                }
            })
            $(".down_num").unbind();
            $(".down_num").click(function () {
                var numObj = $(this).parents(".mizone-input-number").find(".package_product_num");
                if (Utils.isNotNull($.trim(numObj.val())) && $.trim(numObj.val()) > 1 && numObj.attr("disabled") != "disabled") {
                    numObj.val(numObj.val() - 1);
                }
            });
            $(".package_add_clone").unbind();
            $(".sku_input").unbind();
            $(".sku_input").blur(function () {
                var childDetailPackageId = $(this).parents(".package_add_clone_tr").find(".child_detail_sku_Id").val();
                if (Utils.isNotBlack(childDetailPackageId)) {
                    $(this).parents(".package_add_clone_tr").find(".sku_input").val($(this).parents(".package_add_clone_tr").find(".child_detail_sku_name_hidden").val());
                } else {
                    $(this).parents(".package_add_clone_tr").find(".sku_input").val("");
                }
            });
            $(".sku_input").keyup(function () {
                var skuCode = $(this).val();
                var that = $(this)
                if (Utils.isNotBlack($.trim(skuCode))) {
                    var detailIdList = new Array();
                    $(".child_detail_sku_Id").each(function () {
                        var detailId = $(this).val();
                        if (Utils.isNotBlack(detailId)) {
                            detailIdList.push(detailId);
                        }
                    })
                    if (detailIdList.length == 0) {
                        detailIdList = undefined;
                    }
                    ajaxsend({
                        skuCode: $.trim(skuCode),
                        detailIdList: detailIdList,
                        noPackage: true
                    }, "/admin/product/list.json", function (dataJson) {
                        if (dataJson.result.length > 0) {
                            var jsRenderTpl = $.templates('#j-sku-td'),
                                finalTpl = jsRenderTpl(dataJson);
                            that.parents(".mizone-input-number").find(".mizone-input-up").html(finalTpl);
                            that.parents(".mizone-input-number").find(".mizone-input-up").show();
                            that.parents(".mizone-input-number").find(".mizone-input-up").find(".sku_dd").click(function () {
                                var id = $(this).attr("data-id")
                                $(this).parents(".mizone-input-up").hide();
                                for (var i = 0; i < dataJson.result.length; i++) {
                                    var dataObj = dataJson.result[i];
                                    if (dataObj.id == id) {
                                        var trObj = $(this).parents(".package_add_clone_tr");
                                        writePackageDatail(trObj, dataObj);
                                        break;
                                    }
                                }
                            })
                        }
                    })
                } else {
                    $(".mizone-input-up").hide();
                }
            });
            $(".package_add_clone").click(function () {
                if ($(this).attr("disabled") != "disabled") {
                    addPackageClone();
                }

            });
        }

        function addPackageClone() {
            var trAddClone = $($(".package_add_clone_tr")[0]).clone();
            $(trAddClone).find("select").val("");
            $(trAddClone).find("input").val("");
            $(trAddClone).find(".brand").html("");
            $(trAddClone).find(".unit").html("");
            $(trAddClone).find(".category").html("");
            $(trAddClone).find(".mizone-input-up").html("");
            $(trAddClone).find(".package_product_num").val(1);
            $("#package_tbody").append(trAddClone)
            form.render();
            packageOrderName();
            packageAddTrBind();
            packageDeleTrBind();
        }

        /**
         * 写入选择的子类对象数据格式如下{id:id,unit:unit;name:productName,skuCode:skuCode,brandId:brandId,categoryId:categoryId,productNum:productNum}
         * @param that
         * @param dataObj
         */
        function writePackageDatail(trObj, dataObj) {
            var name = dataObj.fullName;
            if (!Utils.isNotNull(dataObj.fullName)) {
                name = dataObj.name;
            }
            trObj.find(".child_detail_sku_Id").val(dataObj.id);
            trObj.find(".unit").html(dataObj.unit);
            trObj.find(".child_detail_sku_name_hidden").val(name + "(" + dataObj.skuCode + ")");
            trObj.find(".sku_input").val(name + "(" + dataObj.skuCode + ")");
            getList("/admin/common/brand/list.json", function (brandJson) {
                var brandReusult = brandJson.result;
                for (var j = 0; j < brandReusult.length; j++) {
                    if (brandReusult[j].id == dataObj.brandId) {
                        trObj.find(".brand").html(brandReusult[j].name);
                        break;
                    }
                }
            }, brandList, {isCommon: isCommon});
            getList("/admin/common/category/list.json", function (categoryJson) {
                var categoryResult = categoryJson.result;
                for (var j = 0; j < categoryResult.length; j++) {
                    if (categoryResult[j].id == dataObj.categoryId) {
                        trObj.find(".category").html(categoryResult[j].name);
                        break;
                    }
                }
            }, categoryList, {isCommon: isCommon});
            if (Utils.isNotNull(dataObj.productNum)) {
                trObj.find(".package_product_num").val(dataObj.productNum)
            }
            if (Utils.isNotNull(dataObj.packageId)) {
                trObj.find(".child_detail_package_Id").val(dataObj.packageId)
            }
            if (Utils.isNotNull(dataObj.skuCode)) {
                trObj.find(".child_detail_package_sku_code").val(dataObj.skuCode)
            }
        }

        function packageDeleTrBind() {
            $(".package_delete_clone").unbind()
            $(".package_delete_clone").click(function () {
                if ($(this).attr("disabled") != "disabled") {
                    if ($(".package_add_clone_tr").length > 1) {
                        $(this).parents(".package_add_clone_tr").remove();
                    }
                    packageOrderName()
                }
            })
        }

        function packageOrderName() {
            var i = 0;
            $(".package_add_clone_tr").each(function () {
                $(this).find(".child_detail_package_Id").each(function () {
                    $(this).attr("name", "productPackageList[" + i + "].id");
                })
                $(this).find(".child_detail_package_sku_code").each(function () {
                    $(this).attr("name", "productPackageList[" + i + "].skuCode");
                })
                $(this).find(".child_detail_sku_Id").each(function () {
                    $(this).attr("name", "productPackageList[" + i + "].childDetailId");
                })
                $(this).find(".package_product_num").each(function () {
                    $(this).attr("name", "productPackageList[" + i + "].productNum");
                });
                $(this).find(".package_order").each(function () {
                    $(this).html(i + 1)
                })
                i++;
            })
        }

        loadInfo();
        packageAddTrBind();
        packageDeleTrBind();
        change();
    })
</script>

<!--<script>
    var moveDom = document.querySelector('.add-com-table-title');
    var origOffsetY = moveDom.offsetTop;
    function onScroll(e) {
        window.scrollY >= origOffsetY ? moveDom.classList.add('sticky') : moveDom.classList.remove('sticky');
    }
    document.addEventListener('scroll', onScroll);
</script>-->
</body>
</html>